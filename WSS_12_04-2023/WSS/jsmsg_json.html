<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" type="text/javascript"></script>
</head>

<body>
   
    <div class="card">
        <div class="card-header" id="time">

        </div>
        <div class="card-body">
                        <table border="1">
                <tr>
                    <td id="tag_name_id_0">
                        Field 0
                    </td>
                    <td id="tag_id_0">
                        asdfg
                    </td>
                </tr>
                <tr>
                    <td id="tag_name_id_1">
                        Field 1
                    </td>
                    <td id="tag_id_1">
                        afsg
                    </td>
                </tr>
                <tr>
                    <td id="tag_name_id_2">
                        Field 2
                    </td>
                    <td id="tag_id_2">
                        asdfg
                    </td>
                </tr>
                <tr>
                    <td id="tag_name_id_3">
                        Field 3
                    </td>
                    <td id="tag_id_3">
                    </td>
                </tr>
                <tr>
                    <td id="tag_name_id_4">
                        Field 4
                    </td>
                    <td id="tag_id_4">
                    </td>
                </tr>
            </table>
            <p>
                <textarea cols="60" rows="6" id="cajadetexto"></textarea>
            </p>
            <p>
                <button id="boton" class="btn btn-primary">Enviar</button>
            </p>
            <p>
                <div id="salida"></div>
            </p>
        </div>
    </div>

    <style type="text/css">
        textarea {
            vertical-align: bottom;
        }

        #salida {
            overflow: auto;
        }

            #salida > p {
                overflow-wrap: break-word;
            }

            #salida span {
                color: blue;
            }

                #salida span.error {
                    color: red;
                }
    </style>

    <script type="text/javascript">
        var len = 0;
        var packages = 0;
        $(document).ready(function () {
            const wsUri = "ws://127.0.0.1:8008/";
            const websocket = new WebSocket(wsUri);
            var json = '[{"name":"val1,12334,1.148"}]';
            console.log(json);
            var data = JSON.parse(json);
            console.log(data);
            fillscreen(data);




            $(document).on("click", "#boton", onClickButton);
            /*
            websocket.onopen = (e) => {                writeToScreen("CONNECTED");
                //query = '{"items":[{"id": "tag1","sname": "job_control","cur_val": "300"},{"id": "tag11","sname": "control","cur_val": "310"}],"tags":[1,2,3,4],"now": "27.03.2023 21:22:23.44","limit": 25}';
                //query = '?form_name=test&abributes=brief&tags=0,1,2,3,4&account=myaccount'
                query = '?form_name=test&abributes=brief&tags=0,1,2,3,4'
                //&abributes=brief
                // brief = tag_name_id_, tag_id_ ,
                doSend(query);
            };
            */
            websocket.onclose = (e) => {
                writeToScreen("DISCONNECTED");
            };

            websocket.onmessage = (e) => {
                //              console.log(e.data);
                //break;
                //const f = document.getElementById("chatbox").contentDocument;
                //  let text = "";
                //console.log(e.data);
                len = len + e.data.length;
                packages = packages + 1;
                //{"items":[{"id": "tag1","sname": "job_control","cur_val": "300"},{"id": "tag11","sname": "control","cur_val": "310"}],
                //"now": "27.03.2023 21:22:23.44","limit": 25}
                //console.log(data);
                //"{""items"":[{""id"": ""tag1"",""sname"": ""job_control"",""cur_val"": ""300""},{""id"": ""tag11"",""sname"": ""mycontrol"",""cur_val"": ""310""}] &" & vbCrLf & "          ""tags"":[1,2,3,4], &" & vbCrLf & "          ""now"": ""27.03.2023 21:22:23.44"",""limit"": 25}"
                //fillscreen(data);
            };

            websocket.onerror = (e) => {
                writeToScreen(`<span class="error">ERROR:</span> ${e.data}`);
            };

            function doSend(message) {
                writeToScreen(`SENT: ${message}`);
                websocket.send(message);
            }

            function writeToScreen(message) {
                $("#salida").append("<p>" + message + "</p>");
            }

            function onClickButton() {
                var text = $("#cajadetexto").val();

                text && doSend(text);
                $("#cajadetexto").val("");
                $("#cajadetexto").focus();
            }
        });
        function writeToScreen(message) { }
        var el = "";
        var targ = "";
        /*
        {"items":[{"id": "tag1","sname": "job_control","cur_val": "300"},{"id": "tag11","sname": "control","cur_val": "310"}],
        "now": "27.03.2023 21:22:23.44","limit": 25}
        */
        function fillscreen(data) {
        //    put_val_by_id('cajadetexto', data.now);
            
          //  console.log(data);
         //   console.log(data.length);
            for (var i = 0; i < data.length; i++) {
                //document.write("<br><br>array index: " + i);
                var obj = data[i];
                for (var key in obj) {
                    var value = obj[key];
                    console.log(key);
                    console.log(value);
                    var varList = value.split(',');
                    console.log(varList);  //, value[1], value[2]);
                    console.log(varList[0]);  //, value[1], value[2]);
                    console.log(varList[1]);  //, value[1], value[2]);
                    console.log(varList[2]);  //, value[1], value[2]);
                    if (key == "time") {
                        value = value + " pakages: " + packages + " bytes: " + len;  } 
                    //else { }
                   // put_val_by_id(key, value);
                  //  document.write("<br> - " + key + ": " + value);
                 ///   console.log(key);
           //         console.log(value);
                }
            }
           //   console.log("----");
            //console.log(data.now);
            /*data.forEach(value => {
                console.log(value);
                console.log(value[0]);
                //console.log(value);
                //switch(value.sname) { //"cur_date"
                //console.log("----");
                //console.log(value.sname);
                //console.log(value.cur_val);
                //put_val_by_id(value.sname, value.cur_val);
            }
            );*/
        }
        function put_val_by_id(id, value) {

            if (document.getElementById(id) != null) {
                //el = $(("#" + id));
                el = document.getElementById(id);
                el.innerHTML = value;
            //    console.log(id);
              //  console.log(value);
            } else {
                console.log(id + " not found");
            }
        }
    </script>
</body>
</html>
